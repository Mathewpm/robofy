# Story 1.2: Setup VPS Environment

## Status
Draft

## Story
**As a** DevOps engineer,
**I want** to set up the VPS hosting environment with Ubuntu 22.04 and necessary services,
**so that** the Robofy website can be deployed to a secure and scalable infrastructure.

## Acceptance Criteria
1. ‚úÖ VPS provisioned on Hetzner (CX11/CX21) or equivalent with Ubuntu 22.04
2. ‚úÖ SSH access configured with key-based authentication and security hardening
3. ‚úÖ PostgreSQL database installed and configured for CRM data
4. ‚úÖ Strapi CMS deployed and operational on the VPS
5. ‚úÖ Basic firewall and security measures implemented (fail2ban, UFW)
6. ‚úÖ Domain DNS configured to point to the VPS IP address

## Tasks / Subtasks
- [ ] Provision VPS instance on Hetzner with Ubuntu 22.04
- [ ] Configure SSH access with key-based authentication and disable root login
- [ ] Set up firewall using UFW (allow SSH, HTTP, HTTPS)
- [ ] Install and configure PostgreSQL database
- [ ] Deploy Strapi CMS with production configuration
- [ ] Configure Nginx as reverse proxy for Strapi and future Next.js app
- [ ] Set up SSL certificates using Let's Encrypt
- [ ] Configure domain DNS records to point to VPS
- [ ] Implement comprehensive security hardening including:
  - [ ] Configure fail2ban for SSH and service protection
  - [ ] Set up automatic security updates (unattended-upgrades)
  - [ ] Harden SSH configuration (disable password authentication, change default port)
  - [ ] Install and configure intrusion detection system (AIDE or similar)
  - [ ] Set up file integrity monitoring
  - [ ] Configure auditd for system auditing
  - [ ] Implement kernel hardening parameters (sysctl)
  - [ ] Set up log monitoring and rotation
  - [ ] Configure time synchronization (chrony or ntp)
  - [ ] Install and configure ClamAV for malware scanning
  - [ ] Set up resource limits and process monitoring
- [ ] Create backup strategy for database and application files

## Dev Notes

### Technical Specifications from Architect Handover
- **Hosting**: Hetzner VPS (CX11 or CX21) with Ubuntu 22.04 [Source: architect-handover.md#Development Tasks]
- **Database**: PostgreSQL for CRM lead storage and AI data [Source: architect-handover.md#Core Architectural Decisions]
- **CMS**: Strapi self-hosted deployment [Source: architect-handover.md#CMS Structure]
- **Security**: Basic server hardening with firewall and security updates [Source: architect-handover.md#Security Requirements]

### Required Services
- PostgreSQL 14+ for database
- Node.js 18+ for Strapi CMS
- Nginx as web server and reverse proxy
- PM2 or similar for process management
- Let's Encrypt for SSL certificates

### Configuration Details
- **Database Connection**: PostgreSQL should be configured with secure authentication
- **Strapi Configuration**: Environment variables for database connection and admin panel
- **Nginx Config**: Reverse proxy settings for Strapi (port 1337) and future Next.js app
- **SSL**: Certbot for automatic SSL certificate generation and renewal

### Security Measures
- **Firewall Configuration**: UFW rules to allow only necessary ports (SSH, HTTP, HTTPS)
- **SSH Hardening**: Key-based authentication only, disable root login, change default port
- **Intrusion Prevention**: fail2ban for SSH and service protection with aggressive jail times
- **Automatic Updates**: Unattended-upgrades for security patches with automatic reboots
- **System Auditing**: auditd configured for critical file and system call monitoring
- **File Integrity**: AIDE or similar for file integrity monitoring with daily checks
- **Kernel Hardening**: sysctl parameters for network and process security
- **Malware Protection**: ClamAV with regular scans and automatic updates
- **Resource Protection**: ulimits and process monitoring to prevent resource exhaustion
- **Log Management**: Centralized logging with rotation and monitoring for security events
- **Database Security**: PostgreSQL exposed only to localhost with encrypted connections
- **Service Isolation**: Non-root user for all application services with minimal privileges

### File Locations
- Nginx configuration: `/etc/nginx/sites-available/robofy`
- Strapi application: `/var/www/strapi/`
- PostgreSQL data: `/var/lib/postgresql/`
- SSL certificates: `/etc/letsencrypt/live/your-domain.com/`

### Testing Standards
- **SSH Security**: Verify key-based authentication works and password login is disabled
- **Firewall Validation**: Test that only allowed ports (SSH, HTTP, HTTPS) are accessible
- **Database Security**: Confirm PostgreSQL only accepts local connections
- **HTTPS Enforcement**: Verify all services redirect HTTP to HTTPS with valid certificates
- **Security Services**: Test fail2ban blocks brute force attempts and auditd is logging
- **File Integrity**: Run AIDE baseline and check for integrity violations
- **Update Verification**: Confirm automatic security updates are enabled and functioning
- **Backup Testing**: Verify backup procedures work and can restore systems
- **Intrusion Detection**: Test that unauthorized access attempts are logged and blocked
- **Performance Impact**: Ensure security measures don't significantly impact system performance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-22 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated during development*

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results
**QA Review Date:** 2025-08-23
**QA Agent:** Quinn (Test Architect & Quality Advisor)
**Overall Status:** FAIL - Not Started

### ‚ùå Critical Issues:
- No evidence of VPS provisioning or server configuration in codebase
- PostgreSQL database not installed or configured
- Security hardening measures (fail2ban, UFW, etc.) not implemented
- Domain DNS configuration not completed
- Zero testing evidence for server infrastructure

### üîß Recommendations:
1. Provision VPS instance on Hetzner or equivalent provider
2. Configure SSH access with key-based authentication and security hardening
3. Install and configure PostgreSQL database for CRM data
4. Implement comprehensive security measures (firewall, fail2ban, automatic updates)
5. Set up monitoring and logging for server infrastructure
6. Conduct security penetration testing and vulnerability scanning

### Quality Gate: FAIL - Infrastructure setup not initiated; cannot proceed to production